---
layout: post
title:  "Expose your Kubernetes Ingress Controller with HAProxy and Cloudflare"
author: alin
categories: [ kubernetes ]
image: https://i.postimg.cc/3xqDSX4Q/cloudflare-haproxy-k8s-2.png
featured: true
hidden: true
---

In the previous article ([link](https://dragomiralin.ro/deploy-kubernetes-on-openstack)), we deployed a Kubernetes Cluster by Kubespray on OpenStack. Now, our cluster is in a private subnet, so we cannot reach it from the outside. We will install an NGINX Ingress Controller to expose our applications, and to reach to the Ingress Controller we will install a HAProxy in front of our kubernetes workers that has both internal and external connectivity.


Other solutions to expose your Kubernetes Services on internet:
- LoadBalancer Service (Octavia Load Balancer on OpenStack) - [cloud-provider-openstack](https://github.com/kubernetes/cloud-provider-openstack)
- Ingress Controller via Load Balancer (Octavia Ingress Controller) - [octavia-ingress-controller](https://github.com/kubernetes/cloud-provider-openstack/blob/master/docs/octavia-ingress-controller/using-octavia-ingress-controller.md)

This time we assume we don't have Octavia Load Balancer, so we need to create our HAProxy load balancer on an instance in front of our worker nodes and direct the traffic to the NGINX Ingress Controller

## Prequiresitions
- OpenStack Provider ([Cloudify.ro](https://cloudify.ro) in my case)
- an Kubernetes Cluster up and running deployed by Kubespray with Terraform and Ansible on OpenStack

## 1. Install NGINX Ingress Controller
We deployed Kubernetes with Ansible, so we are going to install NGINX Ingress Controller with Ansible

```bash
$ vi /inventory/$CLUSTER/group_vars/k8s_cluster/addons.yml
```
```bash
ingress_nginx_enabled: true
ingress_nginx_host_network: true
ingress_publish_status_address: ""
```

Go to your `kubespray` directory to run ansible

```bash
$ ansible-playbook --become -i inventory/$CLUSTER/hosts cluster.yml --tags apps,ingress-nginx,ingress-controller
```

## 2. Create Load Balancer with HAProxy
Create your instance which will be your Load Balancer in front of kubernetes worker nodes.

### 2.a. Create Instance
We have an Openstack Router with interfaces between the internal k8s network and external network. So we will create an Instance on the internal k8s network and then create and attach an OpenStack Floating IP to our instance.
```bash
# Create the Server
$ openstack server create --flavor m1.c-4c-4g \
                        --image docker-ubuntu-20.04 \
                        --network <k8s-private-network \
                        --key-name <your-ssh-key> \
                        --description "HAProxy LoadBalancer for Kubernetes Workers" \
                        k8s-haproxy-workers

# Create OpenStack Floating IP in the public pool
$ openstack floating ip create public

# Look for the server port from the internal network
$ openstack port list --device-id <your_server_id>

# Attach the Floating IP to instance port
$ openstack floating ip set  --port <your_port_server> <floating-ip> (Floating IP to modify (IP address or ID))
```

### 2.b Configure Cloudflare
You have to register your domain on Cloudflare in order to add your DNS record and generate certificates. [Here are the instructions](https://developers.cloudflare.com/fundamentals/get-started/setup/add-site/)

#### 2.b.1 Configure DNS Record for your added domain ([documentation](https://developers.cloudflare.com/dns/manage-dns-records/how-to/create-dns-records/))
- Type: A
- Name: k8s
- Content: `<your-floating-ip-instance>` 



#### 2.b.2 Configure Edge Certificate
- Always Use HTTPS: True
- Automatic HTTPS Rewrites: True
- Your SSL/TLS encryption mode is Full (SSL/TLS - Overview)


#### 2.b.3 Generate Origin Certificates 
This TLS certificates will be installed on our HAProxy instance for encryption between Cloudflare and our origin server.

To generate the certificates use this [instructions](https://developers.cloudflare.com/ssl/origin-configuration/origin-ca/)

  
### 2.c. Install HAProxy
Access the created instance via SSH
```bash
$ ssh ubuntu@<your-floating-ip-instance>
```

Create HAProxy directory
```bash
$ mkdir haproxy
$ mkdir haproxy/certificates
```

We store our origin certificates generated by Cloudflare
```bash
$ vi haproxy/certificates/domain.com.pem
```
Paste in the Origin Certificate and Private Key:
```bash
-----BEGIN CERTIFICATE-----
...
...
-----END CERTIFICATE-----
-----BEGIN PRIVATE KEY-----
...
...
-----END PRIVATE KEY-----
```

Create HAProxy Configuration
```bash
$ vi haproxy/haproxy.cfg
```
```config
global
  stats socket /var/run/api.sock user haproxy group haproxy mode 660 level admin expose-fd listeners
  log stdout format raw local0 info
  crt-base /etc/haproxy/certificates/

defaults
  mode http
  option httplog
  option dontlognull
  option forwardfor
  timeout client 30s
  timeout connect 5s
  timeout server 30s
  timeout http-request 10s
  log global

# HAProxy stats
frontend stats
  bind *:8404
  stats enable
  stats uri /
  stats refresh 10s

# HTTPS Frontend for Kubernetes Worker Nodes
frontend k8s_lb_worker_nodes_https
  bind :443 ssl crt domain.com.pem # Origin Certificates
  acl service ssl_fc_sni k8s.domain.com # Your domain registered on Cloudflare

  use_backend k8s_worker_nodes if service  

  # This redirects to a failure page
  default_backend backend_no_match

backend backend_no_match
    http-request deny deny_status 403

backend k8s_worker_nodes
  server k8s_worker_node_1 <worker_node_1_ip>:80 check # Your Internal IP worker node
  server k8s_worker_node_2 <worker_node_1_ip>:80 check # Your Internal IP worker node
```

### 3. Run HAProxy
Run HAProxy with Docker
```bash
$ sudo docker run -d \
   --name haproxy \
   -v $(pwd):/usr/local/etc/haproxy:ro \
   -p 443:443 \
   haproxytech/haproxy-alpine:2.4
```

### Test Connectivity
```bash
$ curl https://k8s.<your-domain.com>
```
```bash
<html>
<head><title>404 Not Found</title></head>
<body>
<center><h1>404 Not Found</h1></center>
<hr><center>nginx</center>
</body>
</html>
```

Now, we can expose our applications via Ingress Controller

For HAProxy Cluster with high availability - [link](https://itnext.io/kubernetes-journey-up-and-running-out-of-the-cloud-how-to-setup-the-haproxy-cluster-with-high-ee5eb9a7f2e1)

#### References
- [Ingress Controller](https://kubernetes.io/docs/concepts/services-networking/ingress-controllers/)
- [Cloudflare docs](https://developers.cloudflare.com/)
- [HAProxy with Docker](https://www.haproxy.com/blog/how-to-run-haproxy-with-docker/)
- [OpenStack CLI Documentation](https://docs.openstack.org/mitaka/cli-reference/openstack.html)